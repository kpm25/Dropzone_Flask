<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Display</title>
     <link rel="stylesheet" href="static/css/dropzone_styles.css">
        <script src="/static/dependencies/jquery-3.6.0.min.js"></script>

      <style>
    .select-button {
    padding: 10px 20px; /* Increase the size of the buttons */
    margin: 10px; /* Add space around the buttons */
    border-radius: 20px; /* Make the buttons rounded */
    font-size: 1.2em; /* Increase the font size */
    border: 2px solid #007bff;    /* a bold blue border */
    cursor: pointer; /* Change the cursor when hovering over the buttons */
}

/* You can also add some hover effects */
.select-button :hover {
    background-color: #ddd; /* Change the background color */
    color: #333; /* Change the text color */
}
#historyLog {
    width: 100%;
    height: 200px; /* Adjust as needed */
    overflow: auto;
}
    </style>
</head>
<body>

<h1>File Display</h1>
    <div class="container">
        <div class="left-half">

            <div class="left-header-label">
              <span class="label-text">Semester <span id="reset-button">&nbsp&nbsp<button onclick="resetSelections();">Reset</button>&nbsp&nbsp</span></span>

           </div>
            <div class="semester-selector"  id="semester-selector">
                <button id="semester1" class="semester" value="Semester1">1</button>
                <button id="semester2" class="semester" value="Semester2">2</button>
            </div>
            <!-- <div class="left-header-label">Grade <span id="test-data">&nbsp&nbsp<button onclick="test()">Test Button</button></span></div> -->
            <div class="left-header-label">
              <span class="label-text">Grade</span>


            </div>
            <div class="grade-selector" id="grade-selector">
                <button id="grade1" class="grade" value="Grade1">1</button>
                <button id="grade2" class="grade" value="Grade2">2</button>
                <button id="grade3" class="grade" value="Grade3">3</button>
                <button id="grade4" class="grade" value="Grade4">4</button>
                <button id="grade5" class="grade" value="Grade5">5</button>

            </div>

            <div class="header-container">
              <div class="left-header-label">
                <span class="label-text">Week</span>

              </div>
            </div>
            <div class="week-selector" id="week-selector">
                <button id="week1" class="week" value="Week1">1</button>
                <button id="week2" class="week" value="Week2">2</button>
                <button id="week3" class="week" value="Week3">3</button>
                <button id="week4" class="week" value="Week4">4</button>
                <button id="week5" class="week" value="Week5">5</button>
                <button id="week6" class="week" value="Week6">6</button>
                <button id="week7" class="week" value="Week7">7</button>
                <button id="week8" class="week" value="Week8">8</button>
                <button id="week9" class="week" value="Week9">9</button>
                <button id="week10" class="week" value="Week10">10</button>
                 <button id="week11" class="week" value="Week11">11</button>
                <button id="week12" class="week" value="Week12">12</button>
                <button id="week13" class="week" value="Week13">13</button>
                <button id="week14" class="week" value="Week14">14</button>
                <button id="week15" class="week" value="Week15">15</button>
                <button id="week16" class="week" value="Week16">16</button>
                <button id="week17" class="week" value="Week17">17</button>


                <div class="empty"></div>
                <div class="empty"></div>
                <div class="empty"></div>



                    <audio id="successAudio">
                       <source src="/static/audio/sound.mp3" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>

              <button  class="select-button" onclick="playSuccessSound()"   id="playButton">Play Success Sound</button>
<!--                button with link inside to dropzone page-->
<!--                <button class="select-button" onclick="window.location.href='/'" id="dropzoneButton">Go to Dropzone</button>-->
                <button class="select-button" onclick="redirectToDropzone()" id="dropzoneButton">Go to Dropzone</button>

            </div>
            <div class="history-log">
                <h2>History Log</h2>
                <textarea id="historyLog" readonly></textarea>
            </div>
        </div> <!-- left-half -->


          <div class="right-half">
            <div class="right-header-label">File Display Container</div>
            <div class="right-side-container">
                 <div class="lesson-labels-container">
                <div class="lesson-label" id="lesson1" data-target="fileDisplay" data-value="Lesson1">Lesson 1</div>
                <div class="lesson-label" id="lesson2" data-target="fileDisplay" data-value="Lesson2">Lesson 2</div>
                <div class="lesson-label" id="lesson3" data-target="fileDisplay" data-value="Lesson3">Lesson 3</div>
                <div class="lesson-label" id="lesson4" data-target="fileDisplay" data-value="Lesson4">Lesson 4</div>
                <div class="lesson-label" id="lesson5" data-target="fileDisplay" data-value="Lesson5">Lesson 5</div>
                <div class="lesson-label" id="lesson6" data-target="fileDisplay" data-value="Lesson6">Lesson 6</div>
                <div class="lesson-label" id="lesson7" data-target="fileDisplay" data-value="TeachPlans">Teaching Plans</div>
                <div class="lesson-label" id="lesson8" data-target="fileDisplay" data-value="MiscMaterials">Miscellaneous Materials</div>
            </div>
                <div class="file-display" id="fileDisplay">
                        <div class="file-display-files" style="height: 500px; overflow-y: auto;">
                            <!-- Files will be added here -->
                        </div>
                </div>
            </div>
        </div> <!-- right-half -->

    </div>


    <script src="static/js/display_files.js"></script>

 <script>
    // Declare global variables to store the selected grade, semester, week, and lesson
    let selectedGrade = null;
    let selectedSemester = null;
    let selectedWeek = null;
    let selectedLesson = null;


    // Log the variables to the console
    console.log(`selectedGrade: ${selectedGrade}, selectedSemester: ${selectedSemester}, selectedWeek: ${selectedWeek}, selectedLesson: ${selectedLesson}`);


    // Function to update the click event for the lesson labels
    function updateLessonLabelClickEvent() {
        // Remove the existing click event
        document.querySelectorAll('.lesson-label').forEach(function(label) {
            label.removeEventListener('click', labelClickEvent);
        });

        // Add the updated click event
        document.querySelectorAll('.lesson-label').forEach(function(label) {
            label.addEventListener('click', labelClickEvent);
        });
    }
const fileDisplayDiv = document.getElementById('fileDisplay');

    // Function to handle the click event for the lesson labels
function labelClickEvent() {
    //if canLessonBeDisplayed() returns false, display an alert and return
//     if (!canLessonBeDisplayed()) {
//   //alert('Please select a semester, grade, and week before selecting a lesson');
//        return;
//    }else{
//        console.log("canLessonBeDisplayed() is true");
//         //set the lesson labels to be null
//    }

    // Set the selected lesson
    selectedLesson = this.dataset.value;
    console.log("selected lesson is: ", selectedLesson);

    // Fetch the files for the selected semester, grade, week, and lesson
    const fetchUrl = `/list_files/${selectedSemester}/${selectedGrade}/${selectedWeek}/${selectedLesson}`;
    console.log("fetchUrl: ", fetchUrl);
    fetch(fetchUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            // Extract the JSON body of the response
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        console.log("Received data: ", data);

            //if file_count is 0, display an error message and throw an error
            if (data.file_count === 0 ) {
                console.error('No files found for the selected lesson, data:', data);
                throw data;
            }if(!canLessonBeDisplayed()){
                console.error('No Lesson selected, data:', data);
                throw data;
            }
            else {
                    const fileDisplayDiv = document.getElementById('fileDisplay');
                    fileDisplayDiv.innerHTML = `<h1>${data.message}</h1>
                      <p>Directory: ${data.directory}</p>
                      <p>FileCount: ${data.file_count}</p>`;

                    let tableHtml = `<table><thead><tr><th style="text-align: center; color: red; text-decoration: underline;">Files ${data.directory}:</th></tr></thead><tbody>`;
                    tableHtml += '<tr><td> </td></tr>'; // empty row

                    // Add a new row with the checkbox and delete button
                    tableHtml += `<tr><td style="text-align: center;"><input type="checkbox" id="deleteAllCheckbox">
                      <button style="color:green;" id="deleteAllButton">Delete All</button></td></tr>`;

                    for (let i = 0; i < 10; i++) {
                        tableHtml += '<tr><td> </td></tr>'; // empty rows
                    }


                data.files.forEach(file => {
                    const filePath = file.path;
                    console.log("Adding file to table: ", filePath);
                    tableHtml += `<tr><td>&emsp;&emsp;📄 <a href="${file.path}" download>${file.name}  </a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><button style="color:red;" class="delete-button" data-filepath='${filePath}'>Delete</button></td></tr>`;
                    console.log(`file:  ${file.name}, filePath: ${filePath}, data.directory: ${data.directory}`);
                    console.log(`filePath: ${filePath}`);
                });

                fileDisplayDiv.innerHTML += tableHtml;

                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', function() {
                        deleteFile(this.dataset.filepath);
                        console.log("delete button clicked, this.dataset.filepath: ", this.dataset.filepath);
                    });
                });
                //console.log("fileDisplayDiv.innerHTML: ", fileDisplayDiv.innerHTML);

                document.getElementById('deleteAllButton').addEventListener('click', function() {
                    if (document.getElementById('deleteAllCheckbox').checked) {
                        if (confirm('Are you sure you want to delete all files?')) {
                            data.files.forEach(file => {
                                deleteFile(file.path);
                            });
                        }
                    } else {
                        alert('Please check the "Delete All Checkbox" in order to delete all files.');
                    }
                });


            }

    })
    .catch(error => {
        console.error('Error:', error);
        // Display the message and directory path from the server
        const fileDisplayDiv = document.getElementById('fileDisplay');
        fileDisplayDiv.innerHTML = `<h1>${error.message}</h1>
          <p>path: ${selectedSemester}/${selectedGrade}/${selectedWeek}/${selectedLesson}</p>
          <p>Directory: ${error.directory}</p>
          <p>FileCount: ${error.file_count}</p>
        <p>Please select a different lesson or contact the administrator for assistance.</p>`;
    })
}





    // Add event listeners to your buttons
    document.querySelectorAll('.semester').forEach(function(button) {
        button.addEventListener('click', function() {
            selectedSemester = this.value;
            console.log("selected semester is: ", selectedSemester);
            updateLessonLabelClickEvent();
        });
    });

    document.querySelectorAll('.grade').forEach(function(button) {
        button.addEventListener('click', function() {
            selectedGrade = this.value;
            console.log("selected grade is: ", selectedGrade);
            updateLessonLabelClickEvent();
        });
    });
    document.querySelectorAll('.week').forEach(function(button) {
        button.addEventListener('click', function() {
            selectedWeek = this.value;
            console.log("selected week is: ", selectedWeek);
            updateLessonLabelClickEvent();
        });
    });

    // Initialize the click event for the lesson labels
    updateLessonLabelClickEvent();

    //function to display lesson files but checks if semester, grade, week and lesson are selected
    function canLessonBeDisplayed() {
        const isAnySemesterSelected = Array.from(document.querySelectorAll('.semester')).some(semester => semester.classList.contains('selected'));
        const isAnyGradeSelected = Array.from(document.querySelectorAll('.grade')).some(grade => grade.classList.contains('selected'));
        const isAnyWeekSelected = Array.from(document.querySelectorAll('.week')).some(week => week.classList.contains('selected'));
        const isAnyLessonSelected = Array.from(document.querySelectorAll('.lesson-label')).some(lesson => lesson.classList.contains('selected'));

            if (isAnySemesterSelected && isAnyGradeSelected && isAnyWeekSelected && isAnyLessonSelected) {
            const json = {
                semester: isAnySemesterSelected,
                grade: isAnyGradeSelected,
                week: isAnyWeekSelected,
                lesson: isAnyLessonSelected
            };
            console.log("json: ", json);
            return true;
        } else {
            return false;
        }
    }


    function playSuccessSound() {
        const audio = document.getElementById('successAudio');
        if (audio) {
            // Catch promise rejection when trying to play the audio
            audio.play().catch(function(error) {
                console.error('Error playing audio:', error);
            });
        }
    }


    //Code to deal with redirection to dropzone page so that the labels are selected
    // the same as the ones selected on this page

    //function to get lesson int from selectedLesson
    function getLessonInt(lessonString) {
        //if lesson is TP or MS return 7 or 8
        if (lessonString === "TeachPlans") {
            return 7;
        } else if (lessonString === "MiscMaterials") {
            return 8;
        } else if (lessonString.includes('Lesson')){
            return parseInt(lessonString.replace('Lesson', ''));
        } else{
            return null;
        }
    }

    //function to get Selected int id for semester, grade and week selected
    function getSelectedIntId(selectedString) {
        if (selectedString === "Semester1") {
            return 1;
        } else if (selectedString === "Semester2") {
            return 2;
        } else if (selectedString.includes('Grade')) {
            return parseInt(selectedString.replace('Grade', ''));
        } else if (selectedString.includes('Week')) {
            return parseInt(selectedString.replace('Week', ''));
        } else {
            return null;
        }
    }

    function redirectToDropzone() {
        let url = new URL(window.location.origin + '/');

        url.searchParams.append('currentSemester', getSelectedIntId(selectedSemester) !== null ? getSelectedIntId(selectedSemester) : '');
        url.searchParams.append('currentGrade', getSelectedIntId(selectedGrade) !== null ? getSelectedIntId(selectedGrade) : '');
        url.searchParams.append('currentWeek', getSelectedIntId(selectedWeek) !== null ? getSelectedIntId(selectedWeek) : '');

        // Remove 'lesson' from currentLesson and convert to int if null then set to empty string
        let lessonNumber =  getLessonInt(selectedLesson)  || '';
        url.searchParams.append('currentLesson', lessonNumber);

        console.log("*** redirectToDropzone, url: ", url);

        window.location.href = url;
    }

$(document).ready(function() {
        //function to take a current semester as int and return the selected semester as string
        function getSemester(semesterInt) {
            if (semesterInt === 1) {
                return "Semester1";
            } else {
                return "Semester2";
            }
        }
        //function to take a current grade as int and return the selected grade as string
        function getGrade(gradeInt) {
            return "Grade" + gradeInt;
        }
        //function to take a current week as int and return the selected week as string
        function getWeek(weekInt) {
            return "Week" + weekInt;
        }
        //function to take a current lesson as int and return the selected lesson as string
        function getLesson(lessonInt) {
            //if lesson is 7 or 8 return TP or MS
            if (lessonInt === 7) {
                return "TeachPlans";
            } else if (lessonInt === 8) {
                return "MiscMaterials";
            } else {
                return "Lesson" + lessonInt;
            }
        }


        //get params from url to select the labels if they are in the url:

        // Get the URL search parameters
        let params = new URLSearchParams(window.location.search);

        // Only execute the code if there are parameters in the URL
        if (params.toString()) {
            //set the selected semester based on the URL parameters
            let selectedSemesterInt = parseInt(params.get('currentSemester') || null);
            if (isNaN(selectedSemesterInt)) {
                console.log("Invalid semester parameter in URL");
                selectedSemester = null;
            } else {
                selectedSemester = getSemester(selectedSemesterInt);
                // Set the selected semester button
                $(`#semester${selectedSemesterInt}`).addClass('selected');
                //set the other semester to unselected
                $(`#semester${selectedSemesterInt === 1 ? 2 : 1}`).removeClass('selected');
                //set the other semester to unselected
                $(`#semester${selectedSemesterInt === 2 ? 1 : 2}`).removeClass('selected');

            }

            // Set the variables based on the URL parameters
            let selectedGradeInt = parseInt(params.get('currentGrade') || null);
            if (isNaN(selectedGradeInt)) {
                console.log("Invalid grade parameter in URL");
                selectedGrade = null;
            } else {
                selectedGrade = getGrade(selectedGradeInt);
                // Set the selected grade button
                $(`#grade${selectedGradeInt}`).addClass('selected');
                //set the other grade to removed selected and added unselected
                for (let i = 1; i <= 5; i++) {
                    if (i !== selectedGradeInt) {
                        $(`#grade${i}`).removeClass('selected');
                        $(`#grade${i}`).addClass('unselected');
                    }
                }

            }
            // Set the selected week
            let selectedWeekInt = parseInt(params.get('currentWeek') || null);
            if (isNaN(selectedWeekInt)) {
                console.error("Invalid week parameter in URL");
                selectedWeek = null;
            } else {
                selectedWeek = getWeek(selectedWeekInt);
                // Set the selected week button
                $(`#week${selectedWeekInt}`).addClass('selected');
                //set the other week to removed selected and added unselected
                for (let i = 1; i <= 17; i++) {
                    if (i !== selectedWeekInt) {
                        $(`#week${i}`).removeClass('selected');
                        $(`#week${i}`).addClass('unselected');
                    }
                }
            }
            // Set the selected lesson
            let selectedLessonInt = parseInt(params.get('currentLesson') || null);
            if (isNaN(selectedLessonInt)) {
                console.log("Invalid lesson parameter in URL");
                selectedLesson = null;
            } else {
                selectedLesson = getLesson(selectedLessonInt);
                // Set the selected lesson button
                $(`#lesson${selectedLessonInt}`).addClass('selected');
                //set the other lesson to removed selected and added unselected
                for (let i = 1; i <= 8; i++) {
                    if (i !== selectedLessonInt) {
                        $(`#lesson${i}`).removeClass('selected');
                        $(`#lesson${i}`).addClass('unselected');
                    }
                }
            }
        } else {
            console.log("No URL parameters found");
        }



        //debug after loading the page
        console.log(`#####selectedGrade: ${selectedGrade}, selectedSemester: ${selectedSemester}, selectedWeek: ${selectedWeek}, selectedLesson: ${selectedLesson}`);



    }); //end of document ready function



          //use this server code to append the log
        function initialize_log() {
            // Send a GET request to the server to get the history logs
            fetch('/get_logs', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Extract the JSON body of the response
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                console.log("Logs retrieved successfully:", data);
                // Initialize the history log text area
                const historyLog = document.getElementById('historyLog');
                data.forEach(log => {
                 //Yes, the get_history_logs function you provided is correct in terms of handling JSON log entries in the format {'path': path, 'timestamp': timestamp, 'filecount': filecount}.
                    const newLogEntry = `Path: ${log.path}, Timestamp: ${log.timestamp}, File Count: ${log.filecount}\n`;
                    historyLog.value += newLogEntry;
                });
            })
            .catch(error => {
                console.error('Error retrieving logs:', error);
            });
        }

        initialize_log();


         //deletefile function

       function deleteFile(filePath) {
            console.log("filePath: ", filePath);
            console.log("Deleting file:", filePath);

            // Send a DELETE request to the server to delete the file
            fetch(`/delete_file`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "path": filePath
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Extract the JSON body of the response
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                console.log("File deleted successfully:", data);
                // Refresh the file list
                fetchAndDisplayFiles(); // Call the function that fetches and displays the file list
                 playSuccessSound();
            })
            .catch(error => {
                console.error('Error deleting file:', error);
            });
        }



     //function to reset the selections
        function fetchAndDisplayFiles() {
            //get a reference to the selected lesson  and call the labelClickEvent function
            const selectedLesson = document.querySelector('.lesson-label.selected');
            if (selectedLesson) {
                labelClickEvent.call(selectedLesson);
            }


        }

</script>

</body>

</html>